@echo off
SETLOCAL ENABLEDELAYEDEXPANSION

REM --------------------------------------------------
REM Script de chasse de malware avec YARA Rules - COSS
REM --------------------------------------------------

set curPath=%~dp0 

REM ---- la variable curPath contient le chemin du repertoire courant

set workDir=%windir%\temp\MalwareHunt
REM ---- la variable workDir contient le chemin vers le sous repertoire temp\CDCOHUNT dans le repertoire C:\Windows ----


REM ----- À MODIFIER ------------
REM remplacer la valeur de la variable filter par le nom du serveur où les résultats seront stockés.
REM set filer=DESKTOP-AVFRUJ9 
REM remplacer la valeur de la variable filerPath par le nom du dossier sur le serveur où le résultat sera stocké. 
set filerPath=\\192.168.1.171\ScriptHunt

REM Assurez-vous de créer Le sous-dossier dans %filerPath% : "ResultatScanYaraRules"

REM remplacer par un compte d'utilisateur spécialement créer pour la chasse.
set USER=desktop-bfv2kc16\walid
REM remplacer par le compte utilisateur spécialement créer pour la chasse.
set PASS=000
echo TEST4
REM !!!!!!!!!!!!!!! AVERTISSEMENT !!!!!!!!!!!!!!!!!!!!!!
REM le compte utilisé doit avoir la permission de LECTURE/ECRITURE sur le dossier "ResultatScanYaraRules" 
REM !!! CE COMPTE N'A PAS BESOIN D'AUTRES DROITS SUR LES ORDINATEURS !!!
REM ----- À MODIFIER ------------

set mydate=%DATE:/=-%

REM ----------------------
REM Assurez-vous de supprimer toute copie des fichiers précédents. 
REM ---------------------- 
rd /S /Q %workDir% >NUL 2>&1

REM Créer le répertoire
mkdir %workDir%
REM ----------------------
REM Monter un partage réseau
REM ----------------------
REM NET USE %filerpath% /DELETE >NUL 2>&1
REM NET USE %filerpath% /USER:%USER% %PASS% >NUL 2>&1 
REM SET netUseError=%errorlevel% 
REM IF NOT %netUseError%==0 ( 
	REM Exit with error code 1 
REM	echo Error accessing network share "%filerpath%" 
REM	exit 1
REM )

:LancerLeScanYara
REM ----------------------
REM Le Scan YARA Rules est lancé sur tout le repertoire C:\ de l'ordinateur afin de trouver les traces d'infection
REM ----------------------

echo check yararule


%~dp0\yara32.exe -r rules.yar C:\Intel\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\Delta\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\app\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\APPS\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\HP\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\Itel\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\Program Files (x86)\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\Program Files\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\WU\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\Windows\System32\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt
%~dp0\yara32.exe -r rules.yar C:\ProgramData\ 2> nul >> %workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt



:copysusp
REM ----------------------
REM Copie des résultats dans le dossier ResultatScanYaraRules 
REM ---------------------- 
for %%R in (%workDir%\%computername%_INFECTED-%mydate%_YARAScan.txt) do ( 
	if not %%~zR lss 1 (
			robocopy.exe %workdir% "%filerPath%\ResultatScanYaraRules" %computername%_INFECTED-%mydate%_YARAScan.txt /NP /R:10
    )	
	 
)





REM ----------------------
REM demonte le partage réseau
REM ----------------------
REM NET USE %filerpath% /DELETE >NUL 2>&1

:deletetemp
REM ----------------------
REM Suppression des fichiers en local
REM ----------------------
rd /S /Q %workDir% >NUL 2>&1

:eof  
